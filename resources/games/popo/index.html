<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>Hxyman Popo Ver 1.0_Demo:http://www.codefans.net</title>
<meta name="Generator" content="EditPlus">
<meta name="Author" content="Hxyman">
<style>
<!--
body         { font-size: 10pt; font-weight: bold; font-family: Arial; background: #3473d2 }
.box { width:40px; height:40px;}
-->
</style>
</head>
<body>
<span id=Canvas></span>
<bgsound id="sound_main" loop=-1 />
<bgsound id="sound_current_1" loop=1 />
<bgsound id="sound_current_2" loop=1 />
<bgsound id="sound_current_3" loop=1 />
<bgsound id="sound_current_4" loop=1 />
<bgsound id="sound_current_5" loop=1 />
<SCRIPT LANGUAGE="JavaScript">
<!--
/*------------------------------------------------------*\
| WEB泡泡堂v2.0(javascript)
| 写于 2006-9-5 
| 感谢CodeFans.net分流下载
| 最后修改于 2006-9-11
| Hxyman QQ:86815260 EMail:Hxyman at yahoo.com.cn
\*------------------------------------------------------*/
/*------------------------------------------------------*\
| 游戏控制：                                             
| 控制1 方向：wsaf 放泡泡：space 切换道具：e 使用道具：f 
| 控制2 方向：↑↓←→ 放泡泡：enter 切换道具：1 使用道具：0 
\*------------------------------------------------------*/
/*-----------------------------------------------*\
| 模式改变：                                                                                                
| this.ControlPlayer = new Array(-1, -1);                                                                   
| this.ControlPlayer[0]和this.ControlPlayer[1]分别表示控制1和控制2所控制的玩家ID，如果都为-1则为电脑对玩。  
\*-----------------------------------------------*/
/*------------------------------------------------------*\
| 地图制作：
| 仿照以下格式
|   下一行为地图及音效资源的存放路径
| 	this.ResPath[this.ResPath.length] = "pirate";
| 	block上的字符说明：
|   h:障碍(不可炸掉也不可移动) 
|   k:障碍(可以炸掉但不能被移动)
|   y:水平障碍竖直隐藏(不可炸掉也不可移动)
|   g:障碍(可以推动) 
|   数字:玩家ID
| 	下一行为block地图，周围一圈务必为"h"
| 	this.SetMap[this.SetMap.length] = new Array(    
| 		"hhhhhhhhhhh",
| 		"hhkh h hkhh",
| 		"hk0  k   kh",
| 		"hkh hkh hkh",
| 		"hk   h   kh",
| 		"hhkh k hkhh",
| 		"hkkk h kkkh",
| 		"hkkh 1 hkkh",
| 		"hhhhhhhhhhh"
| 	);
| 	下一行为背景地图，周围一较务必为" "
| 	this.SetBackMap[this.SetBackMap.length] = new Array(   
| 		"           ",
| 		" wkwcwcwkw ",
| 		" kccckccck ",
| 		" ksesksesk ",
| 		" kcccsccck ",
| 		" wkwcccwkw ",
| 		" kkkcsckkk ",
| 		" qkwcccwkq ",
| 		"           "
| 	);
\*------------------------------*/

function Player(x, y)
{
	this.x = x;
	this.y = y;
	this.popo = 1;     //可放泡泡数
	this.remain = 1;   //剩余泡泡数
	this.power = 1;    //威力
	this.direct = 3;  //方向
	this.auto = 0;
	this.go = 0;      //是否正在运动
	this.fly = 0;     //是否能飞
	this.speed = 1;   //速度
	this.speed_count = this.speed;
	this.state = 1;   //正常-1 假死-2 真死-0
	this.hidden = 0;  //隐身

	this.addheight = new Array(-16, -46);
	this.addwidth = new Array(0, 0);

	this.moveto = new Array(0, 0); //目标位置
	this.movepath = new Array();   //预设路径

	this.equip_remain = new Array(0,0,0); //道具列表 踢泡泡 针 飞碟
	this.equip_current = 0;
	this.show = new Array("","","");
}

function Bulb(x, y)
{
	this.display = 0;
	this.player = -1;
	this.wait = 0;   //还剩多少时间爆破
	this.power = 1;    //威力
	this.size = 40;
	this.size_max = 40;
	this.size_min = 38;
	this.tendency = 0;
	this.x = x;
	this.y = y;
}

function Popo(ClassName)
{
	this.GetRnd = function(Max){return Math.round(Math.random()*Max)}

	this.ClassName = ClassName;
	this.SetMap = new Array();
	this.SetBackMap = new Array();
	this.ResPath = new Array();
	//海盗船
	this.ResPath[this.ResPath.length] = "pirate";
	this.SetMap[this.SetMap.length] = new Array(
		"hhhhhhhhhhh",
		"hhkh h hkhh",
		"hk0  k   kh",
		"hkh hkh hkh",
		"hk   h   kh",
		"hhkh k hkhh",
		"hkkk h kkkh",
		"hkkh 1 hkkh",
		"hhhhhhhhhhh"
	);
	this.SetBackMap[this.SetBackMap.length] = new Array(
		"           ",
		" wkwcwcwkw ",
		" kccckccck ",
		" ksesksesk ",
		" kcccsccck ",
		" wkwcccwkw ",
		" kkkcsckkk ",
		" qkwcccwkq ",
		"           "
	);
	//鬼屋
	this.ResPath[this.ResPath.length] = "gui";
	this.SetMap[this.SetMap.length] = new Array(
		"hhhhhhhhhhh",
		"hkkk  0kkkh",
		"hhkhh hhkhh",
		"hkk     kkh",
		"h         h",
		"h k     k h",
		"hhkhhghhkhh",
		"hkkk1  kkkh",
		"hhhhhhhhhhh"
	);
	this.SetBackMap[this.SetBackMap.length] = new Array(
		"           ",
		" kkkccckkk ",
		" hkjccjckh ",
		" kkccccckk ",
		" ccccccccc ",
		" ckccccckc ",
		" hkhzczhkh ",
		" kkkccckkk ",
		"           "
	);
	//花园
	this.ResPath[this.ResPath.length] = "garden";
	this.SetMap[this.SetMap.length] = new Array(
		"hhhhhhhhhhh",
		"hk      0kh",
		"hkk hhh kkh",
		"hkkkhhhkkkh",
		"hkkkg gkkkh",
		"hkhhhghhhkh",
		"hkhhh hhhkh",
		"hkkk 1 kkkh",
		"hhhhhhhhhhh"
	);
	this.SetBackMap[this.SetBackMap.length] = new Array(
		"           ",
		" kccccccck ",
		" tkccccckt ",
		" ktkaccktk ",
		" tktccctkt ",
		" kccccccck ",
		" tacccacct ",
		" ktkcccktk ",
		"           "
	);
	//沙漠
	this.ResPath[this.ResPath.length] = "desert";
	this.SetMap[this.SetMap.length] = new Array(
		"hhhhhhhhhhh",
		"hhkhkhkhkhh",
		"hk   1kkkkh",
		"hh h h ykyh",
		"hk  hhh kkh",
		"hykhhhhhkhh",
		"hkkkk    kh",
		"hhkhkhkh0hh",
		"hhhhhhhhhhh"
	);
	this.SetBackMap[this.SetBackMap.length] = new Array(
		"           ",
		" nknknkhkn ",
		" kcccckkkk ",
		" nchchcyky ",
		" kccmccckk ",
		" ykncccckh ",
		" ckkkcccck ",
		" nkhknkhcn ",
		"           "
	);
	//小区
	this.ResPath[this.ResPath.length] = "xiaoqu";
	this.SetMap[this.SetMap.length] = new Array(
		"hhhhhhhhhhh",
		"h1 hg  hkkh",
		"h c   g hgh",
		"hhkhgg  kkh",
		"h h     h h",
		"hkk g  hkhh",
		"hgh  gg   h",
		"hkkhg  h 0h",
		"hhhhhhhhhhh"
	);
	this.SetBackMap[this.SetBackMap.length] = new Array(
		"           ",
		" cctxxxtkk ",
		" ccfuiufdc ",
		" dktuiuckk ",
		" ftfuiuftf ",
		" kkcuiutkd ",
		" cdfuiufcc ",
		" kktxxxtcc ",
		"           "
	);
	//仿照上面，可以在这里加入自定义地图

	this.MapIndex = this.GetRnd(this.SetMap.length-1);
	this.BulbMax = 50;
	this.BulbWait = 70;
	this.BulbBurst = 500;
	this.PlayerRecovery = 5000;
	this.Itv = null;
	this.ControlPlayer = new Array(-1, -1);
	this.DeadsetTimeOut = new Array();
	this.SaysetTimeOut = new Array();
	this.stop = new Array(0,0,0,0);

	this.isend = 0;

	this.SoundTurn = 1;

	this.Player = new Array();
	this.Bulb = new Array();
	for (var i=0; i<this.BulbMax; i++)
	{
		this.Bulb[i] = new Bulb(0, 0);
	}

	this.MapMaxX = this.SetMap[this.MapIndex][0].length;
	this.MapMaxY = this.SetMap[this.MapIndex].length;

	this.BoxWidth = 40;
	this.BoxHeight = 40;

	this.Map = new Array();
	this.BackMap = new Array();
	this.BulbMap = new Array();

	this.ReadMap = function(){
		this.Map.length = 0;
		this.BackMap.length = 0;
		for (var i=0; i<this.MapMaxX; i++)
		{
			this.Map[i] = new Array();
			this.BackMap[i] = new Array();
			this.BulbMap[i] = new Array();
			for (var j=0; j<this.MapMaxY; j++)
			{
				this.Map[i][j] = this.SetMap[this.MapIndex][j].charAt(i);
				this.BackMap[i][j] = this.SetBackMap[this.MapIndex][j].charAt(i);
				this.BulbMap[i][j] = -1;
			}
		}
	}

	//道具
	this.Equip = new Array("","f","","","n","","","n","n","t", "n", "p","","p","r","","","","","");
	this.EchoEquip = function(n){
		return "<img width="+this.BoxWidth+" height="+this.BoxHeight+" src='res/equip_"+n+".gif' />";
	}

	this.DrawBox = function(left, top, width, height, id, str){
		Canvas.insertAdjacentHTML("beforeEnd","<span id='"+id+"' style='position:absolute;left:"+left+";top:"+top+";width:"+width+";height:"+height+";'>"+str+"</span>");
	}

	this.InitBulb = function(n){
		for (var i=0; i<n; i++)
		{
			Canvas.insertAdjacentHTML("beforeEnd","<img id='bulb"+i+"' style='position:absolute;width:"+this.BoxWidth+";height:"+this.BoxHeight+";display:none' src='res/popo.gif' />");
		}
	}

	this.ReDrawBox = function(x, y, str){
		document.getElementById("box"+x+"_"+y).innerHTML = str;
	}

	this.DrawBack = function(i, j, s){
		var left = i*this.BoxWidth;
		var top = j*this.BoxHeight;
		var width = this.BoxWidth;
		var height = this.BoxHeight;
		var zIndex = 0;
		this.DrawBox(left, top, width, height, "bgbg"+i+"_"+j, "<img src=res/"+this.ResPath[this.MapIndex]+"/bg_c.gif style='width:"+width+"px; height:"+height+"px' />");
		switch (s)
		{
			case "d":
				width=40; height=57; top-=17; zIndex=5; break;
			case "h":
				width=40; height=47; top-=7; zIndex=5; break;
			case "t":
				width=40; height=56; top-=16; zIndex=5;
				break;
			case "n":
				width=40; height=65; top-=25; zIndex=5;
				break;
			case "m":
				width=156; height=142; top-=62; zIndex=6;
				break;
			case "y":
				width=40; height=71; top-=31; zIndex=5;
				break;
			case "f":
				width=40; height=57; top-=17; zIndex=5;
				break;
			case "a":
				width=115; height=83; top-=43; zIndex=5;
				break;
			case "j":
				width=80; height=60; top-=20; zIndex=5;
				break;
			case "z":
				width=40; height=132; top-=92; zIndex=5;
				break;
			case "q":
				width=40; height=45; top-=5; zIndex=5;
				break;
			case "w":
				width=40; height=48; top-=8; zIndex=5;
				break;
			case "s":
				width=40; height=49; top-=9; zIndex=5;
				break;
			case "k":
				width=40; height=44; top-=4; zIndex=5;
				break;
			case " ":
				if (0==i)
				{
					if (0==j)
					{
						this.DrawBox(left, top, width, height, "border"+i+"_"+j, "<img src=res/border_lt.gif style='width:"+width+"px; height:"+height+"px;' />");
					}
					else if (this.MapMaxY==j+1)
					{
						this.DrawBox(left, top, width, height, "border"+i+"_"+j, "<img src=res/border_lb.gif style='width:"+width+"px; height:"+height+"px;' />");
					}
					else
					{
						this.DrawBox(left, top, width, height, "border"+i+"_"+j, "<img src=res/border_l.gif style='width:"+width+"px; height:"+height+"px;' />");
					}
				}
				else if (this.MapMaxX==i+1)
				{
					if (0==j)
					{
						this.DrawBox(left, top, width, height, "border"+i+"_"+j, "<img src=res/border_rt.gif style='width:"+width+"px; height:"+height+"px;' />");
					}
					else if (this.MapMaxY==j+1)
					{
						this.DrawBox(left, top, width, height, "border"+i+"_"+j, "<img src=res/border_rb.gif style='width:"+width+"px; height:"+height+"px;' />");
					}
					else
					{
						this.DrawBox(left, top, width, height, "border"+i+"_"+j, "<img src=res/border_r.gif style='width:"+width+"px; height:"+height+"px;' />");
					}
				}
				else if (0==j)
				{
					this.DrawBox(left, top, width, height, "border"+i+"_"+j, "<img src=res/border_t.gif style='width:"+width+"px; height:"+height+"px;' />");
				}
				else if (this.MapMaxY==j+1)
				{
					this.DrawBox(left, top, width, height, "border"+i+"_"+j, "<img src=res/border_b.gif style='width:"+width+"px; height:"+height+"px;' />");
				}
				return 0;
		}
		var str = "<img src=res/"+this.ResPath[this.MapIndex]+"/bg_"+s+".gif style='width:"+width+"px; height:"+height+"px;' />";
		var id = ("k"==this.Map[i][j]?"brick":"bg")+i+"_"+j;
		this.DrawBox(left, top, width, height, id, str);
		document.getElementById(id).style.zIndex = zIndex;
	}
	
	this.DrawRes = function(i, j, s){
		var left = i*this.BoxWidth;
		var top = j*this.BoxHeight;
		var width = this.BoxWidth;
		var height = this.BoxHeight;
		var str = "<img src=res/"+this.ResPath[this.MapIndex]+"/show_"+s+".gif style='width:"+width+"px; height:"+height+"px' />";
		this.DrawBox(left, top, width, height, "box"+i+"_"+j, str);
	}

	this.InitPlayer = function(i, j, PlayerIndex){
		this.Player[PlayerIndex] = new Player(i, j);
		this.Player[PlayerIndex].auto = 1;
		this.Player[PlayerIndex].show[0] = new Array("<img src=\"res/player"+PlayerIndex+"/n0.gif\" />", "<img src=\"res/player"+PlayerIndex+"/n0.gif\" />", "<img src=\"res/player"+PlayerIndex+"/n0.gif\" />", "<img src=\"res/player"+PlayerIndex+"/n0.gif\" />");

		this.Player[PlayerIndex].show[1] = new Array("<img src=\"res/player"+PlayerIndex+"/n0.gif\" />", "<img src=\"res/player"+PlayerIndex+"/n1.gif\" />", "<img src=\"res/player"+PlayerIndex+"/n2.gif\" />", "<img src=\"res/player"+PlayerIndex+"/n3.gif\" />");

		this.Player[PlayerIndex].show[2] = new Array("<img src=\"res/player"+PlayerIndex+"/d.gif\" />", "<img src=\"res/player"+PlayerIndex+"/d.gif\" />", "<img src=\"res/player"+PlayerIndex+"/d.gif\" />", "<img src=\"res/player"+PlayerIndex+"/d.gif\" />");

		this.Player[PlayerIndex].show[3] = new Array("<img src=\"res/player"+PlayerIndex+"/n0.gif\" /><br><img width=40 src=\"res/show_f.gif\" />", "<img src=\"res/player"+PlayerIndex+"/n1.gif\" /><br><img width=40 src=\"res/show_f.gif\" />", "<img src=\"res/player"+PlayerIndex+"/n2.gif\" /><br><img width=40 src=\"res/show_f.gif\" />", "<img src=\"res/player"+PlayerIndex+"/n3.gif\" /><br><img width=40 src=\"res/show_f.gif\" />");

		this.DrawBox(i*this.BoxWidth, j*this.BoxHeight, this.BoxWidth, this.BoxHeight, "player"+PlayerIndex, this.Player[PlayerIndex].show[0][3]);
		document.getElementById("player"+PlayerIndex).style.zIndex = 10;
	}

	this.FreshPlayerPos = function(who){
		if (0==this.Player[who].state) return 0;
		document.getElementById("player"+who).style.left = this.Player[who].x*this.BoxWidth+this.Player[who].addwidth[this.Player[who].fly];
		document.getElementById("player"+who).style.top = this.Player[who].y*this.BoxHeight+this.Player[who].addheight[this.Player[who].fly];
		if (1==this.Player[who].fly)
			document.getElementById("player"+who).innerHTML = this.Player[who].show[3][this.Player[who].direct];
		else
			document.getElementById("player"+who).innerHTML = this.Player[who].show[this.Player[who].state][this.Player[who].direct];
		document.getElementById("player"+who).style.display = 0==this.Player[who].hidden?'':'none';
	}

	this.InitMap = function(){
		this.ReadMap();
		this.Player.length = 0;
		for (var i=0; i<this.MapMaxX; i++)
		{
			for (var j=0; j<this.MapMaxY; j++)
			{
				this.DrawBack(i, j, this.BackMap[i][j]);  //背景地图
				switch(this.Map[i][j])
				{
					case "m":
					case "g":
						this.DrawRes(i, j, this.Map[i][j]);
						break;
					case "k":
					case " ":
						this.DrawBox(i*this.BoxWidth, j*this.BoxHeight, this.BoxWidth, this.BoxHeight, "box"+i+"_"+j, "");
						break;
					case "h": //设置障碍
						break;
					case "y":
						this.DrawBox(i*this.BoxWidth, j*this.BoxHeight, this.BoxWidth, this.BoxHeight, "box"+i+"_"+j, "");
						this.Map[i][j] = "y";
						break;
					default:
						this.DrawBox(i*this.BoxWidth, j*this.BoxHeight, this.BoxWidth, this.BoxHeight, "box"+i+"_"+j, "");
						var PlayerIndex = parseInt(this.Map[i][j]);
						if (!isNaN(PlayerIndex))
						{
							this.InitPlayer(i, j, PlayerIndex);
						}
						this.Map[i][j] = " ";
				}
			}
		}
		for (var i=0; i<this.Player.length; i++)
		{
			if ("undefined"==typeof(this.Player[i])){
				this.InitPlayer(this.GetRnd(this.MapMaxX-4)+1, this.GetRnd(this.MapMaxY-4)+1, i);
				this.Player[i].auto = 1;
				this.Player[i].equip_remain[1] = 2;
				this.Player[i].equip_remain[2] = 1;
			}
			if (1==this.Player[i].auto)
			{
				this.Player[i].speed = 3;
			}
			this.FreshPlayerPos(i); //刷新
		}
		if (-1!=this.ControlPlayer[0]) {this.Player[this.ControlPlayer[0]].auto = 0; this.Player[this.ControlPlayer[0]].speed=1}
		if (-1!=this.ControlPlayer[1]) {this.Player[this.ControlPlayer[0]].auto = 0; this.Player[this.ControlPlayer[0]].speed=1}
	}
	
	//显示说话
	this.Say = function(n, str){
		//window.clearTimeout(this.SaysetTimeOut[n]);
		//document.getElementById("say"+n).innerText = str;
		//this.SaysetTimeOut[n] = setTimeout("document.getElementById('say"+n+"').innerText='';", parseInt(str.length*1000));
	}

	//被杀
	this.Kill = function(n) {
		if (2!=this.Player[n].state) return 0;
		this.PlaySound("挂掉");
		this.Player[n].state = 0;
		this.Player[n].x = 0;
		this.Player[n].y = 0;
		this.FreshPlayerPos(n);
		document.getElementById("head"+n).style.filter = "progid:DXImageTransform.Microsoft.Alpha(opacity=10)"
		for (var i=1; i<=this.Player[n].popo; i++)
		{
			var x = this.GetRnd(this.MapMaxX-4)+1;
			var y = this.GetRnd(this.MapMaxY-4)+1;
			if (this.Map[x][y] == " ")
			{
				this.Map[x][y] = "n";
				this.ReDrawBox(x, y, this.EchoEquip(this.Map[x][y]));
			}
		}
		for (var i=1; i<=this.Player[n].power; i++)
		{
			var x = this.GetRnd(this.MapMaxX-4)+1;
			var y = this.GetRnd(this.MapMaxY-4)+1;
			if (this.Map[x][y] == " ")
			{
				this.Map[x][y] = "p";
				this.ReDrawBox(x, y, this.EchoEquip(this.Map[x][y]));
			}
		}
		for (var i=0; i<this.Player[n].equip_remain[0]; i++)
		{
			var x = this.GetRnd(this.MapMaxX-4)+1;
			var y = this.GetRnd(this.MapMaxY-4)+1;
			if (this.Map[x][y] == " ")
			{
				this.Map[x][y] = "t";
				this.ReDrawBox(x, y, this.EchoEquip(0));
			}
		}
		for (var i=0; i<this.Player[n].equip_remain[1]; i++)
		{
			var x = this.GetRnd(this.MapMaxX-4)+1;
			var y = this.GetRnd(this.MapMaxY-4)+1;
			if (this.Map[x][y] == " ")
			{
				this.Map[x][y] = "r";
				this.ReDrawBox(x, y, this.EchoEquip(1));
			}
		}
		for (var i=0; i<this.Player[n].equip_remain[2]; i++)
		{
			var x = this.GetRnd(this.MapMaxX-4)+1;
			var y = this.GetRnd(this.MapMaxY-4)+1;
			if (this.Map[x][y] == " ")
			{
				this.Map[x][y] = "f";
				this.ReDrawBox(x, y, this.EchoEquip(2));
			}
		}
		this.Statistics();
	}

	this.Campaign = function(self, other){
		if (self == other) return 0;
		if (this.Player[other].state == 2)
		{
			if (parseInt(self%2)==parseInt(other%2))
			{
				this.Recovery(other);
			}
			else
			{
				window.clearTimeout(this.DeadsetTimeOut[other]);
				this.Kill(other);
			}
		}
	}
	
	//移动选手
	this.Move = function(who){
		if (0==this.Player[who].state) return 0;
		var addx = 0;
		var addy = 0;
		var real_move = 1;
		switch(this.Player[who].direct)
		{
			case 0: addx++; break;
			case 1: addy--; break;
			case 2: addx--; break;
			case 3: addy++; break;
		}
		var old = this.Map[this.Player[who].x][this.Player[who].y];
		this.Player[who].x = addx+this.Player[who].x;
		this.Player[who].y = addy+this.Player[who].y;
		var str = " 01ygmnptrf";
		var str2 = " 01ygmknptrf"
		if (str.indexOf(this.Map[this.Player[who].x][this.Player[who].y]) != -1 || (this.Player[who].fly == 1 && str2.indexOf(this.Map[this.Player[who].x][this.Player[who].y]) != -1))
		{
			if (Math.abs(addx)>0) if ("y"==this.Map[this.Player[who].x-addx][this.Player[who].y-addy]) real_move = 0;
			switch(this.Map[this.Player[who].x][this.Player[who].y])
			{
				case "n": //泡泡
					this.Map[this.Player[who].x][this.Player[who].y] = " ";
					this.ReDrawBox(this.Player[who].x, this.Player[who].y, " ");
					this.Player[who].popo++;
					this.Player[who].remain++;
					this.Player[who].hidden = 0;
					this.PlaySound("捡道具");
					break;
				case "p": //威力
					this.Map[this.Player[who].x][this.Player[who].y] = " ";
					this.ReDrawBox(this.Player[who].x, this.Player[who].y, " ");
					this.Player[who].power++;
					this.Player[who].hidden = 0;
					this.PlaySound("捡道具");
					break;
				case "t": //踢
					this.Map[this.Player[who].x][this.Player[who].y] = " ";
					this.ReDrawBox(this.Player[who].x, this.Player[who].y, " ");
					this.Player[who].equip_remain[0]++;
					this.Player[who].hidden = 0;
					this.PlaySound("捡道具");
					break;
				case "r": //马上复活
					this.Map[this.Player[who].x][this.Player[who].y] = " ";
					this.ReDrawBox(this.Player[who].x, this.Player[who].y, " ");
					this.Player[who].equip_remain[1]++;
					this.Player[who].hidden = 0;
					this.PlaySound("捡道具");
					break;
				case "f": //飞碟
					this.Map[this.Player[who].x][this.Player[who].y] = " ";
					this.ReDrawBox(this.Player[who].x, this.Player[who].y, " ");
					this.Player[who].equip_remain[2]++;
					this.Player[who].hidden = 0;
					this.PlaySound("捡道具");
					break;
				case "g":
				case "m"://可移动砖块
					if (this.Map[this.Player[who].x+addx][this.Player[who].y+addy] == " ")
					{
						for (var i=0; i<this.Player.length; i++)
						{
							if (this.Player[i].state>0 && this.Player[i].x==(this.Player[who].x+addx) && this.Player[i].y==(this.Player[who].y+addy))
							{
								real_move = 0;
							}
						}
					}
					else
					{
						real_move = 0;
					}
					if (1 == real_move)
					{
						this.Map[this.Player[who].x+addx][this.Player[who].y+addy] = this.Map[this.Player[who].x][this.Player[who].y];
						this.ReDrawBox(this.Player[who].x+addx, this.Player[who].y+addy, "<img class='box' src='res/"+this.ResPath[this.MapIndex]+"/show_g.gif' />");
						this.Map[this.Player[who].x][this.Player[who].y] = " ";
						this.ReDrawBox(this.Player[who].x, this.Player[who].y, " ");
						if (this.GetRnd(3)>1) this.Say(who, '我推！');
					}
					this.Player[who].hidden = 0;
					break;
				case "y": //隐藏
					if (Math.abs(addx)>0)
					{
						real_move = 0;
					}
					else
					{
						this.Player[who].hidden = 1;
						this.PlaySound("放泡泡");
					}
					break;
				default:
					this.Player[who].hidden = 0;
					
			}
			if (real_move == 1)
			{
				this.FreshPlayerPos(who);
				this.Map[this.Player[who].x-addx][this.Player[who].y-addy] = old;
				this.FreshPanel();
				for (var i=0; i!=who,i<this.Player.length; i++)
				{
					if (this.Player[i].x == this.Player[who].x && this.Player[i].y == this.Player[who].y)
					{
						this.Campaign(who, i);
					}
				}
			}
			else
			{
				this.Player[who].x -= addx;
				this.Player[who].y -= addy;
			}
		}
		else
		{
			real_move = 0;
			this.Player[who].x -= addx;
			this.Player[who].y -= addy;
		}
		return real_move;
	}

	//安放炸弹
	this.Fix = function(who){
		if (this.Player[who].state != 1) return 0;
		var x = this.Player[who].x;
		var y = this.Player[who].y;
		var str = " 01y";
		if (this.Player[who].remain > 0 && str.indexOf(this.Map[x][y]) != -1)
		{
			for (var i=0; i<this.BulbMax; i++)
			{
				if (0 == this.Bulb[i].display)
				{
					this.PlaySound("放泡泡");
					this.Bulb[i] = new Bulb(x, y);
					this.Bulb[i].player = who;
					this.Bulb[i].power = this.Player[who].power;
					this.Bulb[i].wait = this.BulbWait;
					this.Bulb[i].display = 1;
					this.Map[x][y] = "b";
					this.BulbMap[x][y] = i;
					this.Player[who].remain--;
					return 0;
				}
			}
		}
	}

	//被炸到
	this.Dead = function(n){
		if (0 == this.Player[n].fly)
		{
			this.Player[n].state = 2;
			this.Player[n].speed = 5;
			window.clearTimeout(this.DeadsetTimeOut[n]);
			this.DeadsetTimeOut[n] = setTimeout(this.ClassName+".Kill("+n+");", this.PlayerRecovery);
			if (0==this.Player[n].equip_remain[1]) this.Say(n, "快救我！");
		}
		else
		{
			this.Player[n].fly = 0;
			if (this.GetRnd(3)>1) this.Say(n, "晕,飞碟没了！");
		}
		this.FreshPlayerPos(n);
	}

	//爆炸的具体处理过程
	this.DoBurst = function(x, y, dir){
		var GetEquip = " ";
		if ("y"==this.BackMap[x][y]) this.Map[x][y] = "y";
		switch(this.Map[x][y])
		{
			case "k":
				var brick = document.getElementById("brick"+x+"_"+y);
				if (brick) brick.innerHTML = ""; 
			case "g":
				switch(this.Equip[this.GetRnd(this.Equip.length-1)])
				{
					case "n":
						this.Map[x][y] = "n";
						GetEquip = this.EchoEquip(this.Map[x][y]);
						break;
					case "p":
						this.Map[x][y] = "p";
						GetEquip = this.EchoEquip(this.Map[x][y]);
						break;
					case "t":
						this.Map[x][y] = "t";
						GetEquip = this.EchoEquip(0);
						break;
					case "r":
						this.Map[x][y] = "r";
						GetEquip = this.EchoEquip(1);
						break;
					case "f":
						this.Map[x][y] = "f";
						GetEquip = this.EchoEquip(2);
						break;
					default:
						this.Map[x][y] = " ";
				}
				this.stop[dir] = 1;
				break;
			case "h":
			case "d":
			case "m":
				this.stop[dir] = 1;
				return 0;
				break;
			case "y":
				if ( "undefined"==typeof(dir) || (0==dir || 2==dir) )
				{
					this.stop[dir] = 1;
					return 0;
				}
				break;
			default:
				this.Map[x][y] = " ";
		}
		this.PlaySound("炸泡泡");
		this.ReDrawBox(x, y, "<img src='res/burst.gif' />");
		setTimeout(this.ClassName+".ReDrawBox("+x+", "+y+", \""+GetEquip+"\");", this.BulbBurst);

		for (var i=0; i<this.Player.length; i++)
		{
			if (1==this.Player[i].state && this.Player[i].x == x && this.Player[i].y == y)
			{
				this.Dead(i);
			}
		}
	}

	//连爆
	this.OtherBurst = function(x, y, n){
		if (-1!=this.BulbMap[x][y]) this.Bulb[this.BulbMap[x][y]].wait = 0;
	}
	
	//爆炸
	this.Burst = function(n){
		var x = this.Bulb[n].x;
		var y = this.Bulb[n].y;
		if (this.Player[this.Bulb[n].player].remain < this.Player[this.Bulb[n].player].popo) this.Player[this.Bulb[n].player].remain++;
		this.DoBurst(x, y, 0); //处理炸弹中心
		this.stop[0] = 0; this.stop[1] = 0; this.stop[2] = 0; this.stop[3] = 0;
		for (var i=1; i<=this.Bulb[n].power; i++)
		{
			//right
			x += i;
			if (!this.stop[0] && x < this.MapMaxX-1)
			{
				this.DoBurst(x, y, 0); this.OtherBurst(x, y, i);
			}
			x -= i;
			//up
			y += i;
			if (!this.stop[1] && y < this.MapMaxY-1)
			{
				this.DoBurst(x, y, 1); this.OtherBurst(x, y, i);
			}
			y -= i;
			//left
			x -= i;
			if (!this.stop[2] && x > 0)
			{
				this.DoBurst(x, y, 2); this.OtherBurst(x, y, i);
			}
			x += i;
			//down
			y -= i;
			if (!this.stop[3] && y > 0)
			{
				this.DoBurst(x, y, 3); this.OtherBurst(x, y, i);
			}
			y += i;
		}
		document.getElementById("bulb"+n).style.display = 'none';
		this.Bulb[n].display = 0;
		this.BulbMap[x][y] = -1;
	}

	//不断更新炸弹状态
	this.ShowBulb = function(){
		for (var i=0; i<this.BulbMax; i++)
		{
			var obj = document.getElementById("bulb"+i);
			if (this.Bulb[i].wait-- > 0)
			{
			    obj.style.left = this.Bulb[i].x*this.BoxWidth;
			    obj.style.top = this.Bulb[i].y*this.BoxHeight;
				obj.style.display = "";
				if (obj.tendency > 0)
				{
					this.Bulb[i].size++;
					if (this.Bulb[i].size > this.Bulb[i].size_max)
					{
						obj.tendency = 0;
					}
				}
				else
				{
					this.Bulb[i].size--;
					if (this.Bulb[i].size < this.Bulb[i].size_min)
					{
						obj.tendency = 1;
					}
				}
				obj.style.width = this.Bulb[i].size;
				obj.style.height = this.Bulb[i].size;
			}
			else if (this.Bulb[i].display > 0)
			{
				this.Burst(i);
			}
		}
	}

    //复活
	this.Recovery = function(n){
		this.Player[n].state=1;
		this.Player[n].speed = 1;
		window.clearTimeout(this.DeadsetTimeOut[n]);
		this.FreshPlayerPos(n);
	}
	
	//一个方向踢泡泡
	this.KickOne = function(n, dir){
		var x = this.Player[n].x;
		var y = this.Player[n].y;
		var real_dir = dir;
		if (this.Map[x][y] != "b")
		{
			switch(real_dir)
			{
				case 0:
					x++;
					break;
				case 1:
					y--;
					break;
				case 2:
					x--;
					break;
				case 3:
					y++;
					break;
				default:
			}
		}
		else
		{
			real_dir = this.Player[n].direct;
		}
		if (x<=0 || x>=this.MapMaxX || y<=0 || y>=this.MapMaxY) return 0;
		if ("b" == this.Map[x][y])
		{
			var len = parseInt(((real_dir==0||real_dir==1)?this.MapMaxX:this.MapMaxY)/2);
			this.Map[x][y] = " ";
			var old_x = x;
			var old_y = y;
			while(len>0){
				len--;
				switch(real_dir)
				{
					case 0:
						x++;
						if (x >= this.MapMaxX) x = 1;
						break;
					case 1:
						y--;
						if (y <= 0) y = this.MapMaxY-1;
						break;
					case 2:
						x--;
						if (x <= 0) x = this.MapMaxX-1;
						break;
					case 3:
						y++;
						if (y >= this.MapMaxY) y = 1;
						break;
					default:
				}
				if (len<=0 && this.Map[x][y] != " ") len++;
			}
			for (var i=0; i<this.BulbMax; i++)
			{
				if (old_x==this.Bulb[i].x && old_y==this.Bulb[i].y && 1==this.Bulb[i].display)
				{
					this.Bulb[i].x = x; this.Bulb[i].y = y;
				}
			}
			this.Map[old_x][old_y] = " ";
			this.Map[x][y] = "b";
		}
	}

	//四个方向踢
	this.Kick = function(n){
		this.KickOne(n, 0); this.KickOne(n, 1); this.KickOne(n, 2); this.KickOne(n, 3);
	}

	//飞碟
	this.Fly = function(n){
		if (this.Player[n].state != 1) return 0;
		this.Player[n].fly = 1;
		this.FreshPlayerPos(n);
	}

	//使用道具
	this.UseEquip = function(n){
		if (0 == this.Player[n].equip_remain[this.Player[n].equip_current]) return 0;
		switch(this.Player[n].equip_current)
		{
			case 0: //踢泡泡
				if (this.GetRnd(3)>1) this.Say(n, '我踢！');
				this.Kick(n);
				break; 
			case 1: //马上复活
				this.Recovery(n);
				if (this.GetRnd(3)>1) this.Say(n, '我又活了！');
				break;
			case 2: //飞碟
				this.Fly(n);
				if (this.GetRnd(3)>1) this.Say(n, '坐飞碟咯！');
				break;
			default:
		}
		this.Player[n].equip_remain[this.Player[n].equip_current]--;
		this.FreshPanel();
	}

	//换位卡
	this.Alternate = function(n){
		this.PlaySound("换道具");
		var old = this.Player[n].equip_current;
		if (this.Player[n].equip_current <= this.Player[n].equip_remain.length-1)
			this.Player[n].equip_current++;
		if (this.Player[n].equip_current > this.Player[n].equip_remain.length-1)
			this.Player[n].equip_current=0;
		document.getElementById("panel"+n+"_use_"+this.Player[n].equip_current).style.borderColor = '#ffffff';
		document.getElementById("panel"+n+"_use_"+old).style.borderColor = '#3473d2';
		var str = "";
		var num = this.Player[n].equip_remain[this.Player[n].equip_current];
		switch(this.Player[n].equip_current)
		{
			case 0: str="◇"; break;
			case 1: str="╋"; break;
			case 2: str="⌒"; break;
		}
		this.Say(n, str+num);
	}

	this.SetMove = function(n, who, direct){
		if (0==n)
		{
			this.Player[who].direct = direct;
			this.Player[who].go = 1;
		}
		else
		{
			this.Player[who].go = 0;
		}	
		this.FreshPlayerPos(who);
	}

	this.Control = function(n){
		//alert(event.keyCode);
		switch(event.keyCode){
			//player 1
			case 37: //left
				if (-1!=this.ControlPlayer[0]) this.SetMove(n, this.ControlPlayer[0], 2);
				break;
			case 38: //up
				if (-1!=this.ControlPlayer[0]) this.SetMove(n, this.ControlPlayer[0], 1);
				break;
			case 39: //right
				if (-1!=this.ControlPlayer[0]) this.SetMove(n, this.ControlPlayer[0], 0);
				break;
			case 40: //down
				if (-1!=this.ControlPlayer[0]) this.SetMove(n, this.ControlPlayer[0], 3);
				break;
			case 13: //enter
				if (0 == n && -1!=this.ControlPlayer[0]) this.Fix(this.ControlPlayer[0]);
				break;
			case 96: // 0
				if (0 == n && -1!=this.ControlPlayer[0]) this.UseEquip(this.ControlPlayer[0]);
				break;
			case 97: //1
				if (0 == n && -1!=this.ControlPlayer[0]) this.Alternate(this.ControlPlayer[0]);
				break;
			//player 2
			case 65: //left
				if (-1!=this.ControlPlayer[1]) this.SetMove(n, this.ControlPlayer[1], 2);
				break;
			case 87: //up
				if (-1!=this.ControlPlayer[1]) this.SetMove(n, this.ControlPlayer[1], 1);
				break;
			case 68: //right
				if (-1!=this.ControlPlayer[1]) this.SetMove(n, this.ControlPlayer[1], 0);
				break;
			case 83: //down
				if (-1!=this.ControlPlayer[1]) this.SetMove(n, this.ControlPlayer[1], 3);
				break;
			case 32: //space
				if (0 == n && -1!=this.ControlPlayer[1]) if (0 == n) this.Fix(this.ControlPlayer[1]);
				break;
			case 70: // F
				if (0 == n && -1!=this.ControlPlayer[1]) if (0 == n) this.UseEquip(this.ControlPlayer[1]);
				break;
			case 69: //E
				if (0 == n && -1!=this.ControlPlayer[1]) if (0 == n) this.Alternate(this.ControlPlayer[1]);
				break;

			case 77: //M
				if (0==n)
				{
					if (this.SoundTurn > 0)
					{
						this.SoundTurn = 0;
					}
					else
					{
						this.SoundTurn = 1;
					}
				}
				break;
			case 78: //N
				if (0==n)
				{
					if (""==document.getElementById("sound_main").src)
					{
						this.SwitchMainSound(1);
					}
					else
					{
						this.SwitchMainSound(0);
					}
				}
				break;
		}
		if (0 == n) { this.Play(); }
		event.returnValue = false;
	}

	this.ControlChange = function(playerIndex, Control){
		if (-1==Control)
		{
			this.Player[playerIndex].auto = 1;
		}
		else
		{
			this.ControlPlayer[Control] = playerIndex;
			this.Player[playerIndex].auto = 0;
		}
	}

	this.InitPanel = function(){
		var pos_left = (this.MapMaxX*this.BoxWidth)+10;
		var pos_top = 5;
		Canvas.insertAdjacentHTML("beforeEnd","<span id='panel' style='position:absolute;left:"+pos_left+";top:"+pos_top+";'>数据读取中...</span>");
		var str = "";
		str += "说明：<br>"
		str += "控制1 方向：↑↓←→ 放泡泡：enter 切换道具：1 使用道具：0"
		str += "<br>"
		str += "控制2 方向：wsaf 放泡泡：space 切换道具：e 使用道具：f"
		str += "<br>背景音乐开关: n 道具音效开关: m<br><hr>"
		for (var i=0; i<this.Player.length; i++)
		{
			str += "<img id='head"+i+"' src='res/player"+i+"/n3.gif' />&nbsp;&nbsp;&nbsp;&nbsp;Player"+i+"&nbsp;<input type=button name=btn value='控制1' onclick='"+this.ClassName+".ControlChange("+i+",0)' />&nbsp;<input type=button name=btn value='控制2' onclick='"+this.ClassName+".ControlChange("+i+",1)' />&nbsp;<input type=button name=btn value='电脑'  onclick='"+this.ClassName+".ControlChange("+i+",-1)' /><br>"
			str += "<img src='res/equip_n.gif' width='35' height='35' />&nbsp;&nbsp;×&nbsp;&nbsp;<span id=panel"+i+"_popo>"+this.Player[i].popo+"</span>";
			str += "&nbsp;<img src='res/equip_p.gif' width='35' height='35' />&nbsp;&nbsp;×&nbsp;&nbsp;<span id=panel"+i+"_power>"+this.Player[i].power+"</span>";
			str += "&nbsp;<img id='panel"+i+"_use_0' src='res/equip_0.gif' style='border:#ffffff solid 1px' width='35' height='35' />&nbsp;&nbsp;×&nbsp;&nbsp;<span id=panel"+i+"_equip_0>"+this.Player[i].equip_remain[0]+"</span>";
			str += "&nbsp;<img id='panel"+i+"_use_1' src='res/equip_1.gif' style='border:#3473d2 solid 1px' width='35' height='35' />&nbsp;&nbsp;×&nbsp;&nbsp;<span id=panel"+i+"_equip_1>"+this.Player[i].equip_remain[1]+"</span>";
			str += "&nbsp;<img id='panel"+i+"_use_2' src='res/equip_2.gif' style='border:#3473d2 solid 1px' width='35' height='35' />&nbsp;&nbsp;×&nbsp;&nbsp;<span id=panel"+i+"_equip_2>"+this.Player[i].equip_remain[2]+"</span>";
			str += "<br><hr>";
		}
		document.getElementById("panel").innerHTML = str;
	}

	this.FreshPanel = function(){
		for (var i=0; i<this.Player.length; i++)
		{
			document.getElementById("panel"+i+"_popo").innerText = this.Player[i].popo;
			document.getElementById("panel"+i+"_power").innerText = this.Player[i].power;
			document.getElementById("panel"+i+"_equip_0").innerText = this.Player[i].equip_remain[0];
			document.getElementById("panel"+i+"_equip_1").innerText = this.Player[i].equip_remain[1];
			document.getElementById("panel"+i+"_equip_2").innerText = this.Player[i].equip_remain[2];
		}
	}

	//检查物品
	this.AutoFind = function(dir, str, n){
		var x = this.Player[n].x;
		var y = this.Player[n].y;
		if (dir == 0) //水平方向
		{
			var f1 = x;
			var f2 = x;
			while (f1>1 && (this.Map[f1][y]==" " || this.Map[f1][y]==str || (1==this.Player[n].fly && this.Map[f1][y]=="k"))) { f1--;}
			while (f2<this.MapMaxX-1 && (this.Map[f2][y]==" " || this.Map[f2][y]==str || (1==this.Player[n].fly && this.Map[f2][y]=="k"))) { f2++;}
			for (var i=f1; i<=f2; i++)
			{
				if (this.Map[i][y] == str)
				{
					return i;
				}
			}
		}
		else //竖直方向
		{
			var f1 = y;
			var f2 = y;
			while (f1>0 && (this.Map[x][f1]==" " || this.Map[x][f1]==str || (1==this.Player[n].fly && this.Map[x][f1]=="k"))) { f1--;}
			while (f2<this.MapMaxY-1 && (this.Map[x][f2]==" " || this.Map[x][f2]==str || (1==this.Player[n].fly && this.Map[x][f2]=="k"))) { f2++;}
			for (var i=f1; i<=f2; i++)
			{
				if (this.Map[x][i] == str)
				{
					return i;
				}
			}
		}
		return 0;
	}

	//精简路径
	this.ShortPath = function(n){
		var ubd = this.Player[n].movepath.length-1;
		if (0 >= ubd) return 0;
		for (var i=0; i<ubd; i++)
		{
			for (var j=ubd; j>i; j--)
			{
				if (this.Player[n].movepath[i][0]==this.Player[n].movepath[j][0] && this.Player[n].movepath[i][1]==this.Player[n].movepath[j][1])
				{
					this.Player[n].movepath.splice(i, j-i);
					ubd-=(j-i);
					break;
				}
			}
		}
	}

	//查找从开始位置到结束位置的路径 mode: 0-只捡查 1-捡查并保存路径
	this.FindPath = function(x1, y1, x2, y2, n, mode)
	{
		var x = x1;
		var y = y1;
		var addx = 0;
		var addy = 0;
		var c = 2*(Math.abs(x2-x1)+Math.abs(y2-y1)+1);
		if (mode > 0) this.Player[n].movepath.length = 0;
		var AllowStr = " nprtf"
		while (c > 0)
		{
			addx = x<x2?1:(x>x2?-1:0);
			addy = y<y2?1:(y>y2?-1:0);
			if (x > this.MapMaxX-1 || y > this.MapMaxY-1) return 0;
			if (x==x2 && y==y2) return 1;
			if (AllowStr.indexOf(this.Map[x+addx][y])!=-1 || AllowStr.indexOf(this.Map[x][y+addy])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x+addx][y]) || (1==this.Player[n].fly && "k"==this.Map[x][y+addy]) || (1==this.Player[n].direct%2 && "y"==this.Map[x+addx][y]) || (1==this.Player[n].direct%2 && "y"==this.Map[x][y+addy]))
			{
				if (0==this.GetRnd(1))
				{
					if (AllowStr.indexOf(this.Map[x+addx][y])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x+addx][y]) || (1==this.Player[n].direct%2 && "y"==this.Map[x+addx][y]))
					{
						x += addx; 
						if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
						if (x==x2 && y==y2) return 1;
						if (AllowStr.indexOf(this.Map[x][y+addy])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x][y+addy]) || (1==this.Player[n].direct%2 && "y"==this.Map[x][y+addy]))
						{
							y += addy;
							if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
							if (x==x2 && y==y2) return 1;
						}
					}
					else if (AllowStr.indexOf(this.Map[x][y+addy])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x][y+addy]) || (1==this.Player[n].direct%2 && "y"==this.Map[x][y+addy]))
					{
						y += addy;
						if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
						if (x==x2 && y==y2) return 1;
						if (AllowStr.indexOf(this.Map[x+addx][y])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x+addx][y]) || (1==this.Player[n].direct%2 && "y"==this.Map[x+addx][y]))
						{
							x += addx;
							if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
							if (x==x2 && y==y2) return 1;
						}
					}
				}
				else
				{
					if (AllowStr.indexOf(this.Map[x][y+addy])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x][y+addy]) || (1==this.Player[n].direct%2 && "y"==this.Map[x][y+addy]))
					{
						y += addy;
						if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
						if (x==x2 && y==y2) return 1;
						if (AllowStr.indexOf(this.Map[x+addx][y])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x+addx][y]) || (1==this.Player[n].direct%2 && "y"==this.Map[x+addx][y]))
						{
							x += addx;
							if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
							if (x==x2 && y==y2) return 1;
						}
					}
					else if (AllowStr.indexOf(this.Map[x+addx][y])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x+addx][y]) || (1==this.Player[n].direct%2 && "y"==this.Map[x+addx][y]))
					{
						x += addx; 
						if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
						if (x==x2 && y==y2) return 1;
						if (AllowStr.indexOf(this.Map[x][y+addy])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x][y+addy]) || (1==this.Player[n].direct%2 && "y"==this.Map[x][y+addy]))
						{
							y += addy;
							if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
							if (x==x2 && y==y2) return 1;
						}
					}
				}
			}
			else
			{
				if (0==addx && 0==addy)
				{
					return 1;
				}
				else if (0==addx)
				{
					addx = x<x1?-1:1;
					if (AllowStr.indexOf(this.Map[x+addx][y])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x+addx][y]) || (1==this.Player[n].direct%2 && "y"==this.Map[x+addx][y]))
					{
						x += addx;
						if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
						if (x==x2 && y==y2) return 1;
					}
					else if (AllowStr.indexOf(this.Map[x][y-addy])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x][y-addy]) || (1==this.Player[n].direct%2 && "y"==this.Map[x][y-addy]))
					{
						y += addy;
						if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
						if (x==x2 && y==y2) return 1;
					}
				}
				else if (0==addy)
				{
					addy = y<y1?-1:1;
					if (AllowStr.indexOf(this.Map[x][y+addy])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x][y+addy]) || (1==this.Player[n].direct%2 && "y"==this.Map[x][y+addy]))
					{
						y += addy;
						if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
						if (x==x2 && y==y2) return 1;
					}
					else if (AllowStr.indexOf(this.Map[x-addx][y])!=-1 || (1==this.Player[n].fly && "k"==this.Map[x-addx][y]) || (1==this.Player[n].direct%2 && "y"==this.Map[x-addx][y]))
					{
						x += addx;
						if (mode > 0) this.Player[n].movepath[this.Player[n].movepath.length] = new Array(x, y);
						if (x==x2 && y==y2) return 1;
					}
					else
					{
						return 0;
					}
				}
			}
			c--;
		}
		return 0;
	}

	//躲开泡泡
	this.AutoAvoid = function(n){
		if (this.Player[n].movepath.length > 0) return 0; 
		if (1 == this.AutoIsSafe(this.Player[n].x, this.Player[n].y)) return 1;
		var beginx = this.Player[n].x-5;
		var endx = this.Player[n].x+5;
		if (beginx <= 0) beginx =1;
		if (endx >= this.MapMaxX-1) endx = this.MapMaxX-2;
		var beginy = this.Player[n].y-5;
		var endy = this.Player[n].y+5;
		if (beginy <= 0) beginy =1;
		if (endy >= this.MapMaxY-1) endy = this.MapMaxY-2;
		var arr = new Array();
		var AllowStr = " nprtf"

		for (var i=beginx; i<=endx; i++)
		{
			for (var j=beginy; j<endy; j++)
			{
				if ((AllowStr.indexOf(this.Map[i][j])!=-1 || ("k"==this.Map[i][j] && 1==this.Player[n].fly)) && 1==this.AutoIsSafe(i, j))
				{
					arr[arr.length] = new Array(i, j);
				}
			}
		}

		if (arr.length > 0)
		{
			//打乱数组
			for (var i=0; i<arr.length; i++)
			{
				var rnd = this.GetRnd(arr.length-1);
				var temparr = arr[rnd];
				arr[rnd] = arr[i];
				arr[i] = temparr;
			}
			for (var i=0; i<arr.length; i++)
			{
				if (1 == this.FindPath(this.Player[n].x, this.Player[n].y, arr[i][0], arr[i][1], n, 1))
				{
					this.ShortPath(n);
					this.Say(n, "我逃！");
					return 0;
				}
			}
		}

		return 1;
	}

	//周围泡泡检查
	this.AutoIsSafe = function(x, y){
		for (var i=0; i<this.BulbMax; i++)
		{
			if (1==this.Bulb[i].display)
			{
				if (Math.abs(x-this.Bulb[i].x)<=this.Bulb[i].power && y==this.Bulb[i].y) return 0;
				if (Math.abs(y-this.Bulb[i].y)<=this.Bulb[i].power && x==this.Bulb[i].x) return 0;
			}
		}
		return 1;
	}

	//检查定制线路
	this.AutoLine = function(n){
		if (this.Player[n].movepath.length>0)
		{
			var arr = this.Player[n].movepath.shift();
			if (arr[0]>this.Player[n].x)
			{
				this.Player[n].direct = 0;
			}
			else if (arr[0]<this.Player[n].x)
			{
				this.Player[n].direct = 2;
			}
			else
			{
				if (arr[1]>this.Player[n].y)
				{
					this.Player[n].direct = 3;
				}
				else
				{
					this.Player[n].direct = 1;
				}
			}
			if (0==this.Move(n)) this.Player[n].movepath.length=0;
			return 0;
		}
		return 1;
	}

	//检查定制目标
	this.AutoTask = function(n){
		if (this.Player[n].moveto[0]>0)
		{
			if ( (this.Player[n].x==this.Player[n].moveto[0] && this.Player[n].y==this.Player[n].moveto[1]) || 0==this.Move(n) )
			{
				this.Player[n].moveto[0] = 0; this.Player[n].moveto[1] = 0;
				return 1;
			}
			else
			{
				return 0;
			}
		}
		return 1;
	}

	//任务方向
	this.AutoSetTaskDirect = function(n){
		if (this.Player[n].moveto[0] == this.Player[n].x) //竖直方向
		{
			if (this.Player[n].moveto[1] > this.Player[n].y)
			{
				this.Player[n].direct = 3;
			}
			else
			{
				this.Player[n].direct = 1;
			}
		}
		else
		{
			if (this.Player[n].moveto[0] > this.Player[n].x)
			{
				this.Player[n].direct = 0;
			}
			else
			{
				this.Player[n].direct = 2;
			}
		}
	}

	//追踪敌人
	this.AutoFollow = function(n){
		if (this.Player[n].movepath.length > 0) return 0;
		for (var i=0; i<this.Player.length; i++)
		{
			if (i%2!=n%2 && 1==this.Player[i].state)
			{
				if (1 == this.FindPath(this.Player[n].x, this.Player[n].y, this.Player[i].x, this.Player[i].y, n, 0))
				{
					this.Player[n].movepath.length = 0; //移除当前任务
					this.FindPath(this.Player[n].x, this.Player[n].y, this.Player[i].x, this.Player[i].y, n, 1);
					this.ShortPath(n);
					if (this.GetRnd(10)>8) this.Say(n, "不信挂不了你！");
					return 0;
				}
			}
		}
		return 1;
	}

	//检查是否有友方或敌方被炸到
	this.AutoCheckPlayer = function(n){
		for (var i=0; i<this.Player.length; i++)
		{
			if (i!=n && 2==this.Player[i].state)
			{
				if (1 == this.FindPath(this.Player[n].x, this.Player[n].y, this.Player[i].x, this.Player[i].y, n, 0))
				{
					this.Player[n].movepath.length = 0; //移除当前任务
					this.FindPath(this.Player[n].x, this.Player[n].y, this.Player[i].x, this.Player[i].y, n, 1);
					this.ShortPath(n);
					this.Say(n, i%2==n%2?"我救你！":"挂了你！");
					return 0;
				}
			}
		}
		return 1;
	}

	//道具检查
	this.AutoCheckEquip = function(n){
		if (this.Player[n].moveto[0] > 0) return 0; 
		var len = this.Equip.length;
		var temp = 0;
		var str = "";
		for (var i=0; i<len; i++)
		{
			str = ""+this.Equip[i]+"";
			if (str.length = 0) continue;
			temp = this.AutoFind(0, str, n);
			if (temp > 0)
			{
				this.Player[n].moveto[0] = temp;
				this.Player[n].moveto[1] = this.Player[n].y;
				this.AutoSetTaskDirect(n);
				this.Say(n, "我抢！" );
			}
			else
			{
				temp = this.AutoFind(1, str, n);
				if (temp > 0)
				{
					this.Player[n].moveto[0] = this.Player[n].x;
					this.Player[n].moveto[1] = temp;
					this.AutoSetTaskDirect(n);
					this.Say(n, "我抢！" );
				}
			}
		}
		return 1;
	}

	//放泡泡攻击敌方
	this.AutoBulb = function(n){
		if (this.GetRnd(5)>0 && this.Player[n].popo>4)
		{
			this.Fix(n);
		}
		else
		{
			for (var i=0; i<this.Player.length; i++)
			{
				if (i%2!=n%2 && this.Player[i].state>0  && Math.abs(this.Player[i].x-this.Player[n].x)<=this.Player[n].power && Math.abs(this.Player[i].y-this.Player[n].y)<=this.Player[n].power)
				{
					this.Fix(n);
					return 0;
				}
			}
		}
	}

	//自动使用道具
	this.AutoUseEquip = function(n, i){
		while(this.Player[n].equip_current != i)
		{
			this.Alternate(n);
		}
		this.UseEquip(n);
	}
	
	//自动操作
	this.AutoPlay = function(n){
		switch(this.GetRnd(300))
		{
			case 0: this.Say(n, '手气不错！'); break;
			case 1: this.Say(n, '玩得没什么味！'); break;
			case 2: this.Say(n, '按键太不灵敏了！'); break;
			case 3: this.Say(n, '呵呵！'); break;
			case 4: this.Say(n, '嘿嘿！'); break;
			case 5: this.Say(n, '嘟嘟嘟！'); break;
			case 6: this.Say(n, '好慢！'); break;
			case 7: this.Say(n, '...'); break;
			case 8: this.Say(n, '！'); break;
			case 9: this.Say(n, '汗！'); break;
			case 10: this.Say(n, '晕！'); break;
			case 11: this.Say(n, '吼！'); break;
			case 12: this.Say(n, '刚刚谁炸我？'); break;
			case 13: this.Say(n, '加油！'); break;
			case 14: this.Say(n, '我炸！'); break;
			case 15: this.Say(n, '??？'); break;
		}
		switch(this.Player[n].state)
		{
			case 2: //被炸到
				this.AutoUseEquip(n, 1);
				break;
			case 1: //正常状态
				if (0 == this.Player[n].fly) this.AutoUseEquip(n, 2);
			
				if (0 != this.AutoCheckPlayer(n)) //检查是否有队友或敌人被炸到
				{
					if (0 != this.AutoAvoid(n)) //逃避泡泡
					{ 
						if (0 != this.AutoCheckEquip(n)) //检查是否有道具捡
						{        
							if (this.GetRnd(3)>0 && this.Player[n].popo>4)
							{
								this.AutoFollow(n);           //跟踪敌人
								this.AutoBulb(n);
							}
						}
					}
				}

				if (0 == this.AutoLine(n)) return 0;
				if (0 == this.AutoTask(n)) return 0;

				var x = this.Player[n].x;
				var y = this.Player[n].y;
				switch(this.Player[n].direct)
				{
					case 0:
						x++; break;
					case 1:
						y--; break;
					case 2:
						x--; break;
					case 3:
						y++; break;
				}
				if (x<=0 || x>=this.MapMaxX || y<=0 || y>=this.MapMaxY) //出界
				{
					this.Player[n].direct = this.GetRnd(3);
				}
				else
				{
					if (0==this.AutoIsSafe(x, y) && -1==this.BulbMap[this.Player[n].x][this.Player[n].y])
					{
						this.Player[n].direct = this.GetRnd(3);
						return 0;
					}

					var temp = 0;

					switch(this.Map[x][y])
					{
						case "h":
							temp = this.GetRnd(10);
							if (temp > 1)
							{
								this.Player[n].direct = this.GetRnd(3);
							}
							else
							{
								this.Fix(n);
							}
							break;
						case "k": 
							temp = this.GetRnd(10);
							if (this.Player[n].fly == 0 || this.GetRnd(10) > 4)
							{
								if (temp > 3)
								{
									this.Fix(n);
								}
								else
								{
									this.Player[n].direct = this.GetRnd(3);
								}
							}
							else
							{
								if (temp > 3)
								{
									this.Move(n);
								}
								else if (temp > 1)
								{
									this.Player[n].direct = this.GetRnd(3);
								}
							}
							break;
						case "g": 
							temp = this.GetRnd(10);
							if (temp > 4)
							{
								this.Move(n);
							}
							else if (temp > 2)
							{
								this.Fix(n);
							}
							else
							{
								this.Player[n].direct = this.GetRnd(3);
							}
							break;
						case "m": 
							temp = this.GetRnd(10);
							if (temp > 4)
							{
								this.Move(n);
							}
							else if (temp > 2)
							{
								this.Player[n].direct = this.GetRnd(3);
							}
							else
							{
								this.Fix(n);
							}
							break;
						case "b":
							temp = this.GetRnd(10);
							this.AutoUseEquip(n, 0);
							this.Player[n].direct = this.GetRnd(3);
							break;
						case " ":
							temp = this.GetRnd(10);
							if (temp>1 && 1==this.AutoIsSafe(this.Player[n].x, this.Player[n].y))
								this.Move(n);
							else
								this.Player[n].direct = this.GetRnd(3);
							this.AutoBulb(n);
							break;
						case "t":
						case "r":
						case "f":
						case "n":
						case "p":
							if (this.AutoIsSafe(this.Player[n].x, this.Player[n].y))
								this.Move(n);
							else
								this.Player[n].direct = this.GetRnd(3);
							break;
						case "y":
							if (0==this.Player[n].direct && 2==this.Player[n].direct)
							{
								temp = this.GetRnd(10);
								if (temp>1 && 1==this.AutoIsSafe(this.Player[n].x, this.Player[n].y))
									this.Move(n);
								else
									this.Player[n].direct = this.GetRnd(3);
								this.AutoBulb(n);
								break;
							}
						default:
							this.Player[n].direct = this.GetRnd(3);
							this.Move(n);
					}
				}
				break;
		}
	}

	this.Play = function(){
		for (var i=0; i<this.Player.length; i++)
		{
			this.Player[i].speed_count--;
			if (this.Player[i].speed_count < 0) this.Player[i].speed_count = this.Player[i].speed;
			if (this.Player[i].speed_count == 0)
			{
				if (0 == this.Player[i].auto)
				{
					if (1 == this.Player[i].go) this.Move(i);
				}
				else
				{
					this.AutoPlay(i);
				}
			}
		}
	}
	
	//统计胜负
	this.Statistics = function(){
		if (1==this.isend) return 0;
		var arr = new Array(0, 0);
		var num = parseInt(this.Player.length/2)
		for (var i=0; i<this.Player.length; i++)
		{
			if (0 == this.Player[i].state)
			{
				arr[i%2]++;
			}
		}
		if (arr[0]>=num || arr[1]>=num)
		{
			this.isend = 1;
			var str = "";
			if (this.Player[0].auto==this.Player[1].auto)
			{
				str = (arr[0]>arr[1]?"单":"双")+"号胜！"
			}
			else
			{
				var win = arr[0]>arr[1]?1:0;
				str = (0==this.Player[win].auto?"玩家":"电脑")+"胜！"
			}
			this.End(str);
		}
	}

	this.SwitchMainSound = function(n){
		if (1==n)
		{
			document.getElementById("sound_main").src = "res/"+this.ResPath[this.MapIndex]+"/bgsound.wav";
		}
		else
		{
			document.getElementById("sound_main").src = "";
		}
		
	}

	this.PlaySound = function(dowhat){
		if (0==this.SoundTurn) return 0;
		var path = "";
		this.SoundTurn++;
		if (this.SoundTurn>5) this.SoundTurn = 1;
		switch(dowhat)
		{
			case "放泡泡": path="100.wav"; break;
			case "炸泡泡": path="101.wav"; break;
			case "捡道具": path="001.wav"; break;
			case "挂掉": path="201.wav"; break;
			case "换道具": path="102.wav"; break;
		}
		document.getElementById("sound_current_"+this.SoundTurn).src = "res/music/"+path;
	}

	this.Loop = function(){
		this.Play();
		this.ShowBulb();
	}
	
	this.End = function(str){
		window.clearInterval(this.Itv);
		Canvas.insertAdjacentHTML("beforeEnd","<span id='showresult' style='position:absolute;left:"+((this.MapMaxX/2)*this.BoxWidth-80)+";top:"+((this.MapMaxY/2)*this.BoxHeight-40)+";z-index:100;width:400;height:100;color:white;font-size:28px;'>"+str+"</span>");
		setTimeout("location.reload();", 5000);
	}

	this.Begin = function(){
		this.InitMap();
		this.InitPanel();
		this.SwitchMainSound(1);
		this.InitBulb(this.BulbMax);
		this.Itv = window.setInterval(""+this.ClassName+".Loop()", 10); //主进程
	}
}

var game = new Popo("game");
game.Begin();

function document.onkeydown(){game.Control(0)}
function document.onkeyup(){game.Control(1)}
//-->
</SCRIPT>
</body>
</html>
